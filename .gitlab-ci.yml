stages:
  - test
  - package
  - release

default:
  image: maven:3.9.6-eclipse-temurin-21
  cache:
    key: "${CI_PROJECT_NAME}"
    paths:
      - .m2/repository
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end"

maven_verify:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS verify
  artifacts:
    when: always
    reports:
      junit: target/surefire-reports/TEST-*.xml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: "$CI_COMMIT_TAG"
    - if: "$CI_COMMIT_BRANCH"

maven_package:
  stage: package
  needs: ["maven_verify"]
  script:
    - mvn $MAVEN_CLI_OPTS -DskipTests package
  artifacts:
    paths:
      - target/mfa-enrollment-orchestrator-*.jar
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: "$CI_COMMIT_TAG"
    - if: "$CI_COMMIT_BRANCH"

release_tag:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: maven_package
      artifacts: true
  rules:
    - if: "$CI_COMMIT_TAG"
    - when: never
  before_script:
    - apk add --no-cache curl jq
    - export GITLAB_TOKEN="$CI_JOB_TOKEN"
  script:
    - PACKAGE_FILE=$(ls target/mfa-enrollment-orchestrator-*.jar | head -n 1)
    - test -n "$PACKAGE_FILE"
    - |
      UPLOAD_RESPONSE=$(curl --fail --silent --show-error \
        --request POST \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --form "file=@${PACKAGE_FILE}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/uploads")
    - ASSET_URL=$(echo "$UPLOAD_RESPONSE" | jq -r .url)
    - ASSET_NAME=$(basename "$PACKAGE_FILE")
    - FULL_ASSET_URL="${CI_SERVER_URL}${ASSET_URL}"
    - |
      release-cli create \
        --name "Release ${CI_COMMIT_TAG}" \
        --tag-name "${CI_COMMIT_TAG}" \
        --ref "${CI_COMMIT_TAG}" \
        --description "Automated release for ${CI_COMMIT_TAG}" \
        --assets-link "{\"name\":\"${ASSET_NAME}\",\"url\":\"${FULL_ASSET_URL}\",\"filepath\":\"/${ASSET_NAME}\"}"
